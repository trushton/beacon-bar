<html>
<head>
    <title>Facebook Login JavaScript Example</title>
    <meta charset="UTF-8">
    <script src="jquery.min.js" type="text/javascript" language="javascript"><!--jquery-ui.position--></script>
    <script src="jquery-ui.min.js" type="text/javascript" language="javascript"></script>
    <link rel="stylesheet" href="jquery-ui.min.css" type="text/css" media="all" />

    <link rel="stylesheet" href="styles.css" type="text/css" media="all" />




    <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>

    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyCvDt__-j-koRzjvYOtlXmMjcjHrX9SPho",
            authDomain: "beaconbar-e8384.firebaseapp.com",
            databaseURL: "https://beaconbar-e8384.firebaseio.com",
            storageBucket: "beaconbar-e8384.appspot.com",
            messagingSenderId: "9892124037"
        };
        firebase.initializeApp(config);
        firebase.auth().signInWithEmailAndPassword('thomas.rushton@originate.com', 'testpass');
    </script>


</head>
  <body id="immediateDevice">

    <div id="background" style="width:1024px; height:768px;">
    </div>

    <div id="device">
        <h3 id="tester">Things should be displayed here</h3>
    </div>
    <div id="storage"></div>
    <div style="width:100%;color:black;text-align:center"><dl><dt>locator</dt><dd id="locator"></dd></dl></div>

    <script src="newaer-immediate.js" type="text/javascript" language="javascript"></script>


    <script>
        window.fbAsyncInit = function() {
            FB.init({
                appId      : '988112061288748',
                cookie     : true,  // enable cookies to allow the server to access
                                    // the session
                xfbml      : true,  // parse social plugins on this page
                version    : 'v2.8' // use graph api version 2.8
            });

        };

        // Load the SDK asynchronously
        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));


        function checkIfRegistered(){
            var ref = firebase.database().ref('users/');
            var userBadge = window.localStorage.getItem("currentDevice");
            if(userBadge === null){userBadge = '';}

            ref.once('value').then(function(snapshot){
                if(!snapshot.hasChild('userBadge')){
                    $("#device").html("<div id='immediateBanner'><p>Got a VIP beacon badge?<br>Unlock the magic!</p></div>" +
                        '<button onclick="login()">Register your badge with Facebook</button>'+
                        '<div id="dataProtection">Don\'t worry, we won\'t save any of your data.</div>');
                }
                else{
                    var user = snapshot.child(userBadge);
                    $("#device").html("<h2>Good to see you again " + user.child('username').val() + "</h2>" +
                        "<img src='" + user.child('picture').val() + "'>" +
                        "<h3>You've been here " + (user.child('visitCount').val()+1) + " times</h3>"
                    );
                    firebase.database().ref('users/' + userBadge).update({visitCount: user.child('visitCount').val()+1});
                }
            });
        }



        function processFriends(token, userId, friendList){
            var friends = firebase.database().ref('friends/');

            friendList.forEach(function(friend){
                //friends.child(userId).once('value').then(function(snapshot) {
                // var friendBadge = getBadgeId(friend.id);
                // if(!snapshot.val()){
                //     friends.child(userId).push(friendBadge);
                //     friends.child(friendBadge).push(userId);
                // }
                // else{
                //     snapshot.forEach(function(id){
                //         if(getBadgeId(id.val()) !== friendBadge){
                //             friends.child(userId).push(friendBadge);
                //             friends.child(friendBadge).push(userId);
                //         }
                //     });
                // }
                //});
            });

        }

        function getBadgeId(facebookId){
            firebase.database().ref('badges/'+facebookId).once('value').then(function(snapshot){
                if(snapshot.child('badge')){
                    return snapshot.child('badge').val();
                }
            });
        }


        function createUser(token, data){
            var likes = [], location = '', cover = '';
            if(data.likes){ likes = data.likes.data; }
            if(data.location){ location = data.location.name;}
            if(data.cover){ cover = data.cover.source.toString(); }

            var badgeId = window.localStorage.getItem("currentDevice");
            if(badgeId === null || badgeId === undefined){badgeId = '';}
            firebase.database().ref('users/'+ badgeId).set({
                facebookId: data.id,
                username: data.name,
                //birthday: data.birthday,
                likes: likes,
                location: location,
                picture: data.picture.data.url.toString(),
                cover: cover,
                visitCount: 1,
                barCount: 0,
                foodCount: 0,
                vrCount: 0,
                lastSeen: Date.now()
            });
            firebase.database().ref('badges/' + badgeId).push({badge: badgeId, test: 'did it work'});
            // processFriends(token, badgeId, data.friends.data).then(function(){
            //     if(calculateAge(data.birthday) > 20){
            window.location = 'https://www.facebook.com/logout.php?next=https://beacon-bar-file-server.herokuapp.com/sxsw/host/drink_pref.html&access_token=' + token;
            //     } else {
            //         window.location = 'https://www.facebook.com/logout.php?next=https://beacon-bar-file-server.herokuapp.com/sxsw/host/completedRegistration.html&access_token=' + token;
            //     }
            // });

        }

        function calculateAge(birthday){
            var ageDifMs = Date.now() - new Date(birthday);
            var ageDate = new Date(ageDifMs);
            return Math.abs(ageDate.getUTCFullYear() - 1970);
        }

        function checkLoginState(token) {
            if (token) {

                FB.api('/me', {access_token: token, fields: ['name', 'picture.type(large)', 'birthday', 'friends', 'likes', 'hometown', 'location', 'cover']}, function(data) {
                    localStorage.setItem("user_id", data.id);
                    createUser(token, data);
                });
            } else {
                document.getElementById('status').innerHTML = 'Please log ' +
                    'into Facebook.';
            }
        }
        function login() {
            window.location = "https://www.facebook.com/v2.8/dialog/oauth?client_id=988112061288748&scope=user_birthday,user_likes,user_friends&response_type=token&redirect_uri=http://beacon-bar-file-server.herokuapp.com/sxsw/host/immediatedevice.html";
        }


        function firebaseLogin(access_token){
            var credential = firebase.auth.FacebookAuthProvider.credential(access_token);
            firebase.auth().signInWithCredential(credential).then(function(){
                checkLoginState(access_token);
            });
        }
        checkIfRegistered();
        var regex = new RegExp('#access_token' + "(=([^&#]*)|&|#|$)");
        var results = regex.exec(window.location.href);
        console.log(results);
        if(results && results[2]) {
            firebaseLogin(results[2]);
        }
    </script>


  </body>
</html>
